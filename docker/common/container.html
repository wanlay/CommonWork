<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ELK | my-site</title>
    <meta name="description" content="mysite">
    <link rel="icon" href="/document/favicon.ico">
    
    <link rel="preload" href="/document/assets/css/styles.5eb717b1.css" as="style"><link rel="preload" href="/document/assets/js/app.5eb717b1.js" as="script"><link rel="preload" href="/document/assets/js/4.b23a15d0.js" as="script"><link rel="prefetch" href="/document/assets/js/1.ddf42c38.js"><link rel="prefetch" href="/document/assets/js/10.aca434fd.js"><link rel="prefetch" href="/document/assets/js/11.51601390.js"><link rel="prefetch" href="/document/assets/js/12.ad28f615.js"><link rel="prefetch" href="/document/assets/js/13.ac59c3d1.js"><link rel="prefetch" href="/document/assets/js/14.9a885008.js"><link rel="prefetch" href="/document/assets/js/15.f3655483.js"><link rel="prefetch" href="/document/assets/js/16.fd334191.js"><link rel="prefetch" href="/document/assets/js/17.7d7907a4.js"><link rel="prefetch" href="/document/assets/js/18.509fb0d1.js"><link rel="prefetch" href="/document/assets/js/19.849def23.js"><link rel="prefetch" href="/document/assets/js/2.68be4103.js"><link rel="prefetch" href="/document/assets/js/20.a45e76c6.js"><link rel="prefetch" href="/document/assets/js/21.6708f267.js"><link rel="prefetch" href="/document/assets/js/22.96d5c709.js"><link rel="prefetch" href="/document/assets/js/23.d43e6b88.js"><link rel="prefetch" href="/document/assets/js/24.6adcba5c.js"><link rel="prefetch" href="/document/assets/js/25.ebd3b924.js"><link rel="prefetch" href="/document/assets/js/26.4040aa58.js"><link rel="prefetch" href="/document/assets/js/27.50d8fb00.js"><link rel="prefetch" href="/document/assets/js/28.35f30a1a.js"><link rel="prefetch" href="/document/assets/js/29.86a6c76b.js"><link rel="prefetch" href="/document/assets/js/3.27896c98.js"><link rel="prefetch" href="/document/assets/js/30.a8f2d9ad.js"><link rel="prefetch" href="/document/assets/js/31.aa2e6fe8.js"><link rel="prefetch" href="/document/assets/js/32.c8127cc3.js"><link rel="prefetch" href="/document/assets/js/33.ab0c0d25.js"><link rel="prefetch" href="/document/assets/js/34.c54d6fbf.js"><link rel="prefetch" href="/document/assets/js/35.b062d65d.js"><link rel="prefetch" href="/document/assets/js/36.59518d28.js"><link rel="prefetch" href="/document/assets/js/37.d20c65a1.js"><link rel="prefetch" href="/document/assets/js/38.fb2890b5.js"><link rel="prefetch" href="/document/assets/js/39.ff39d369.js"><link rel="prefetch" href="/document/assets/js/40.51730ac4.js"><link rel="prefetch" href="/document/assets/js/41.4d899e1c.js"><link rel="prefetch" href="/document/assets/js/42.12d30c89.js"><link rel="prefetch" href="/document/assets/js/43.0542e2b0.js"><link rel="prefetch" href="/document/assets/js/44.e6ce2834.js"><link rel="prefetch" href="/document/assets/js/45.aa0bfb53.js"><link rel="prefetch" href="/document/assets/js/5.9aeab741.js"><link rel="prefetch" href="/document/assets/js/6.c2ff2458.js"><link rel="prefetch" href="/document/assets/js/7.ac6af82a.js"><link rel="prefetch" href="/document/assets/js/8.d108ed4a.js"><link rel="prefetch" href="/document/assets/js/9.6d42ccf6.js">
    <link rel="stylesheet" href="/document/assets/css/styles.5eb717b1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/document/" class="home-link router-link-active"><!----><span class="site-name">
      my-site
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/document/linux/" class="nav-link">linux</a></div><div class="nav-item"><a href="/document/docker/" class="nav-link router-link-active">docker</a></div><div class="nav-item"><a href="/document/language/" class="nav-link">语言</a></div><div class="nav-item"><a href="/document/windows/" class="nav-link">windows</a></div><div class="nav-item"><a href="/document/others/" class="nav-link">其他</a></div><a href="https://github.com/wanlay/document" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/document/linux/" class="nav-link">linux</a></div><div class="nav-item"><a href="/document/docker/" class="nav-link router-link-active">docker</a></div><div class="nav-item"><a href="/document/language/" class="nav-link">语言</a></div><div class="nav-item"><a href="/document/windows/" class="nav-link">windows</a></div><div class="nav-item"><a href="/document/others/" class="nav-link">其他</a></div><a href="https://github.com/wanlay/document" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>基础</span><!----></p><ul class="sidebar-group-items"><li><a href="/document/docker/common/install.html" class="sidebar-link">安装</a></li><li><a href="/document/docker/common/tips.html" class="sidebar-link">tips</a></li><li><a href="/document/docker/common/github.html" class="sidebar-link">Docker Cheat Sheet</a></li><li><a href="/document/docker/common/container.html" class="active sidebar-link">ELK</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#elk" class="sidebar-link">ELK</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#karaf日志输出到elk" class="sidebar-link">karaf日志输出到elk</a></li><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#filebeat输出到elk" class="sidebar-link">filebeat输出到elk</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#nexus3" class="sidebar-link">nexus3</a></li><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#onos" class="sidebar-link">ONOS</a></li><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#rancher" class="sidebar-link">rancher</a></li><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#portainer" class="sidebar-link">portainer</a></li><li class="sidebar-sub-header"><a href="/document/docker/common/container.html#sonarqube" class="sidebar-link">sonarqube</a></li></ul></li><li><a href="/document/docker/common/Dockerfile.html" class="sidebar-link">Dockerfile</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>k8s</span><!----></p><ul class="sidebar-group-items"><li><a href="/document/docker/k8s/install.html" class="sidebar-link">安装</a></li><li><a href="/document/docker/k8s/cmd.html" class="sidebar-link">CMD</a></li><li><a href="/document/docker/k8s/service.html" class="sidebar-link">service</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h2 id="elk"><a href="#elk" aria-hidden="true" class="header-anchor">#</a> ELK</h2><p>使用sebp/elk镜像<br>
运行时，日志报</p><div class="language- extra-class"><pre class="language-text"><code>max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]
</code></pre></div><p>需增加宿主机的内存,至少需要2G</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 设置</span>
<span class="token function">sudo</span> sysctl -w vm.max_map_count<span class="token operator">=</span><span class="token number">262144</span>
<span class="token comment"># 查看</span>
sysctl vm.max_map_count
</code></pre></div><blockquote><p>docker-compose.yml</p></blockquote><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>  
<span class="token key atrule">services</span><span class="token punctuation">:</span>  
     <span class="token key atrule">elk</span><span class="token punctuation">:</span>  
       <span class="token key atrule">image</span><span class="token punctuation">:</span> sebp/elk<span class="token punctuation">:</span><span class="token number">520</span>
       <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  
        <span class="token punctuation">-</span> elk<span class="token punctuation">-</span>volume<span class="token punctuation">:</span>/var/lib/elasticsearch
        <span class="token comment">#映射目录</span>
        <span class="token punctuation">-</span> ./karaf.conf<span class="token punctuation">:</span>/etc/logstash/conf.d/karaf.conf             
       <span class="token key atrule">ports</span><span class="token punctuation">:</span>  
        <span class="token punctuation">-</span> <span class="token string">&quot;5044:5044&quot;</span> 
        <span class="token punctuation">-</span> <span class="token string">&quot;5601:5601&quot;</span> 
        <span class="token punctuation">-</span> <span class="token string">&quot;9200:9200&quot;</span>  
        <span class="token punctuation">-</span> <span class="token string">&quot;9300:9300&quot;</span>  
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
     <span class="token key atrule">elk-volume</span><span class="token punctuation">:</span>
</code></pre></div><h3 id="karaf日志输出到elk"><a href="#karaf日志输出到elk" aria-hidden="true" class="header-anchor">#</a> karaf日志输出到elk</h3><p>删除容器目录/etc/logstash/conf.d/下的文件
新建karaf.conf</p><div class="language-conf extra-class"><pre class="language-text"><code>input {
 log4j {
 mode =&gt; &quot;server&quot;
 port =&gt; 5044
 }
}
output {
    stdout {
      codec =&gt; rubydebug
    }
    elasticsearch{
        hosts =&gt; [&quot;localhost:9200&quot;]
        index =&gt; &quot;karaf-%{+YYYY.MM.dd}&quot;
        document_type =&gt; &quot;log4j_type&quot;
    }
}
</code></pre></div><p>重启容器服务
修改<code>karaf的etc/org.ops4j.pax.logging.cfg</code> (对应<code>ONOS_ROOT/tools/package/etc</code>)</p><div class="language-conf extra-class"><pre class="language-text"><code># Root logger
log4j.rootLogger=DEBUG, out, logstash,syslog, sift, osgi:*
...
#logstash
log4j.appender.logstash=org.apache.log4j.net.SocketAppender
log4j.appender.logstash.port=5044
log4j.appender.logstash.remoteHost=10.190.23.244  
</code></pre></div><h3 id="filebeat输出到elk"><a href="#filebeat输出到elk" aria-hidden="true" class="header-anchor">#</a> filebeat输出到elk</h3><blockquote><p>Dockerfile</p></blockquote><div class="language-docker extra-class"><pre class="language-docker"><code><span class="token keyword">From</span> prima/filebeat
<span class="token keyword">ADD</span> filebeat.yml /filebeat.yml
<span class="token keyword">RUN</span> chmod go<span class="token punctuation">-</span>w /filebeat.yml
</code></pre></div><blockquote><p>filebeat.yml</p></blockquote><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">filebeat</span><span class="token punctuation">:</span>
    <span class="token key atrule">prospectors</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span>
            <span class="token key atrule">paths</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token string">&quot;/var/onos/log/*.log&quot;</span>
<span class="token key atrule">output</span><span class="token punctuation">:</span>
    <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
        <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;10.190.23.244:9200&quot;</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>docker-compose.yml</p></blockquote><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>  
<span class="token key atrule">services</span><span class="token punctuation">:</span>  
     <span class="token key atrule">cbb</span><span class="token punctuation">:</span>  
       <span class="token key atrule">image</span><span class="token punctuation">:</span> cbb
       <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  
        <span class="token punctuation">-</span> cbb<span class="token punctuation">-</span>volume<span class="token punctuation">:</span>/root/onos/apache<span class="token punctuation">-</span>karaf<span class="token punctuation">-</span>3.0.5/data/log/
     <span class="token key atrule">filebeat</span><span class="token punctuation">:</span>
       <span class="token key atrule">image</span><span class="token punctuation">:</span> olinicola/filebeat<span class="token punctuation">:</span>1.2.3
       <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  
        <span class="token punctuation">-</span> cbb<span class="token punctuation">-</span>volume<span class="token punctuation">:</span>/var/onos/log/
        <span class="token punctuation">-</span> ./filebeat.yml<span class="token punctuation">:</span>/etc/filebeat/filebeat.yml
       <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> cbb
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
     <span class="token key atrule">cbb-volume</span><span class="token punctuation">:</span>

</code></pre></div><h2 id="nexus3"><a href="#nexus3" aria-hidden="true" class="header-anchor">#</a> nexus3</h2><blockquote><p>docker-compose.yml</p></blockquote><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">neuxs-network</span><span class="token punctuation">:</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nexus3</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> sonatype/nexus3<span class="token punctuation">:</span>latest
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">&quot;journald&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> neuxs<span class="token punctuation">-</span>network
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">&quot;8088:8088&quot;</span>
     <span class="token punctuation">-</span> <span class="token string">&quot;8081:8081&quot;</span>
     <span class="token punctuation">-</span> <span class="token string">&quot;5000:5000&quot;</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;nexus-data:/nexus-data&quot;</span>
  
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">nexus-data</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="onos"><a href="#onos" aria-hidden="true" class="header-anchor">#</a> ONOS</h2><p>下载<code>onosproject/onos</code>镜像</p><div class="language- extra-class"><pre class="language-text"><code>docker pull onosproject/onos
</code></pre></div><p>自定义Dockerfile</p><div class="language- extra-class"><pre class="language-text"><code>FROM java:8-jre-alpine
MAINTAINER wanlay

RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories &amp;&amp; \
    apk update &amp;&amp; apk add --no-cache bash curl openssh

COPY . /root/onos/

RUN   mkdir -p /root/onos/apache-karaf-3.0.5/data/log &amp;&amp; \
touch /root/onos/apache-karaf-3.0.5/data/log/karaf.log &amp;&amp; \
ln -sf /dev/stdout /root/onos/apache-karaf-3.0.5/data/log/karaf.log

EXPOSE 6653 6640 8181 8101 9876

WORKDIR /root/onos

CMD [&quot;./bin/onos-service&quot;]
</code></pre></div><p>制作docker镜像</p><div class="language- extra-class"><pre class="language-text"><code>sudo docker build -t wanlay/cbb .
</code></pre></div><p>下载onos-form-cluster</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> https://raw.githubusercontent.com/opennetworkinglab/onos/master/tools/package/bin/onos-form-cluster 

<span class="token function">chmod</span> u+x onos-form-cluster
</code></pre></div><p>将下面代码加入.bashrc</p><div class="language-bash extra-class"><pre class="language-bash"><code>docker-<span class="token function-name function">ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">sudo</span> docker inspect --format <span class="token string">'{{ .NetworkSettings.IPAddress }}'</span> <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行onos镜像</p><div class="language- extra-class"><pre class="language-text"><code>sudo docker run  -t -d --name cbb1 wanlay/cbb
</code></pre></div><p>将多个onos实例形成集群</p><div class="language-bash extra-class"><pre class="language-bash"><code>./onos-form-cluster -u onos -p rocks <span class="token variable"><span class="token variable">`</span>docker-ip cbb1<span class="token variable">`</span></span> <span class="token variable"><span class="token variable">`</span>docker-ip cbb2<span class="token variable">`</span></span> <span class="token variable"><span class="token variable">`</span>docker-ip cbb3<span class="token variable">`</span></span>
</code></pre></div><p>ssh连接到onos命令行</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ssh</span> -p <span class="token number">8101</span> onos@<span class="token variable"><span class="token variable">`</span>docker-ip cbb1<span class="token variable">`</span></span>  
<span class="token comment">#密码是rocks</span>
</code></pre></div><h2 id="rancher"><a href="#rancher" aria-hidden="true" class="header-anchor">#</a> rancher</h2><blockquote><p>docker-compose</p></blockquote><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mysqldb</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure<span class="token punctuation">:</span><span class="token number">10</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">&quot;journald&quot;</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token string">&quot;3306:3306&quot;</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MYSQL_ROOT_PASSWORD=root
      <span class="token punctuation">-</span> MYSQL_DATABASE=rancher
      <span class="token punctuation">-</span> MYSQL_USER=rancher
      <span class="token punctuation">-</span> MYSQL_PASSWORD=rancher 
      
  <span class="token key atrule">rancher-server</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> rancher/server
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure<span class="token punctuation">:</span><span class="token number">10</span>
    <span class="token key atrule">logging</span><span class="token punctuation">:</span>
      <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">&quot;journald&quot;</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token string">&quot;5555:8080&quot;</span>
    <span class="token key atrule">links</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mysqldb<span class="token punctuation">:</span>rancher
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> db<span class="token punctuation">-</span>user=rancher
      <span class="token punctuation">-</span> db<span class="token punctuation">-</span>pass=rancher
      <span class="token punctuation">-</span> db<span class="token punctuation">-</span>name=rancher
      <span class="token punctuation">-</span> advertise<span class="token punctuation">-</span>address=10.190.23.245   
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>添加主机时，agent所在的主机的docker版本要与server端的一样</p></div><h2 id="portainer"><a href="#portainer" aria-hidden="true" class="header-anchor">#</a> portainer</h2><p>创建集群</p><div class="language- extra-class"><pre class="language-text"><code>docker swarm init --advertise-addr 10.190.23.241
</code></pre></div><p>运行portainer</p><div class="language- extra-class"><pre class="language-text"><code>docker service create \
--name portainer \
--publish 9000:9000 \
--constraint 'node.role == manager' \
--mount type=bind,src=//var/run/docker.sock,dst=/var/run/docker.sock \
portainer/portainer \
-H unix:///var/run/docker.sock
</code></pre></div><h2 id="sonarqube"><a href="#sonarqube" aria-hidden="true" class="header-anchor">#</a> sonarqube</h2><blockquote><p>docker-compose.yml</p></blockquote><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarqube</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> sonarqube
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure<span class="token punctuation">:</span><span class="token number">10</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;9000:9000&quot;</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sonarnet
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> SONARQUBE_JDBC_URL=jdbc<span class="token punctuation">:</span>postgresql<span class="token punctuation">:</span>//pg<span class="token punctuation">-</span>sonarqube<span class="token punctuation">:</span>5432/sonar
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sonarqube_volume<span class="token punctuation">:</span>/opt/sonarqube
  <span class="token key atrule">pg-sonarqube</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> on<span class="token punctuation">-</span>failure<span class="token punctuation">:</span><span class="token number">10</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sonarnet
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> POSTGRES_USER=sonar
      <span class="token punctuation">-</span> POSTGRES_PASSWORD=sonar
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pg_sonarqube_volume<span class="token punctuation">:</span>/var/lib/postgresql/data

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarnet</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">sonarqube_volume</span><span class="token punctuation">:</span>
  <span class="token key atrule">pg_sonarqube_volume</span><span class="token punctuation">:</span>
</code></pre></div><blockquote><p>配置LADP</p></blockquote><p>sonarqube 界面上安装LDAP插件 ，或者把插件拷贝到<code>{sonarqube_volume}/extensions/plugins</code><br>
添加以下字段到<code>{sonarqube_volume}/conf/sonar.properties</code></p><div class="language-conf extra-class"><pre class="language-text"><code># LDAP configuration
# General Configuration
sonar.security.realm=LDAP
ldap.url=ldap://10.190.23.240
ldap.bindDn=cn=cbbadmin,ou=accounts,dc=fiberhome,dc=com
ldap.bindPassword=cbb2017
 
# User Configuration
ldap.user.baseDn=ou=accounts,dc=fiberhome,dc=com
ldap.user.request=(&amp;(objectClass=inetOrgPerson)(uid={login}))
ldap.user.realNameAttribute=cn
ldap.user.emailAttribute=mail
 
# Group Configuration
ldap.group.baseDn=ou=groups,dc=fiberhome,dc=com
ldap.group.request=(&amp;(objectClass=posixGroup)(memberUid={uid}))
</code></pre></div></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/wanlay/document/edit/master/docs/docker/common/container.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="last-updated"><span class="prefix">上次更新: </span><span class="time">3/1/2019, 4:26:52 AM</span></div></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/document/docker/common/github.html" class="prev">
          Docker Cheat Sheet
        </a></span><span class="next"><a href="/document/docker/common/Dockerfile.html">
          Dockerfile
        </a> →
      </span></p></div></div></div></div>
    <script src="/document/assets/js/app.5eb717b1.js" defer></script><script src="/document/assets/js/4.b23a15d0.js" defer></script>
  </body>
</html>
